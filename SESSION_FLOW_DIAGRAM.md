# Session Token Flow Diagram

## Initial Login Flow
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”
â”‚ User    â”‚                 â”‚ Frontend â”‚                 â”‚ Backend â”‚                 â”‚ Redis â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”¬â”€â”€â”€â”˜
     â”‚                           â”‚                            â”‚                          â”‚
     â”‚ 1. Click "Unlock"         â”‚                            â”‚                          â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚                          â”‚
     â”‚                           â”‚                            â”‚                          â”‚
     â”‚                           â”‚ 2. Request Challenge       â”‚                          â”‚
     â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
     â”‚                           â”‚                            â”‚                          â”‚
     â”‚                           â”‚ 3. Return Challenge        â”‚                          â”‚
     â”‚                           â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚
     â”‚                           â”‚                            â”‚                          â”‚
     â”‚ 4. Passkey Prompt         â”‚                            â”‚                          â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚                          â”‚
     â”‚                           â”‚                            â”‚                          â”‚
     â”‚ 5. Biometric Auth         â”‚                            â”‚                          â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚                          â”‚
     â”‚                           â”‚                            â”‚                          â”‚
     â”‚                           â”‚ 6. Verify Passkey          â”‚                          â”‚
     â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
     â”‚                           â”‚                            â”‚                          â”‚
     â”‚                           â”‚                            â”‚ 7. Store Session (30min) â”‚
     â”‚                           â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                           â”‚                            â”‚                          â”‚
     â”‚                           â”‚ 8. Return sessionToken     â”‚                          â”‚
     â”‚                           â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚
     â”‚                           â”‚                            â”‚                          â”‚
     â”‚                           â”‚ 9. Save to localStorage    â”‚                          â”‚
     â”‚                           â”‚    - token                 â”‚                          â”‚
     â”‚                           â”‚    - expiresAt (30min)     â”‚                          â”‚
     â”‚                           â”‚    - address               â”‚                          â”‚
     â”‚                           â”‚                            â”‚                          â”‚
     â”‚ 10. Redirect to Dashboard â”‚                            â”‚                          â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚                          â”‚
     â”‚                           â”‚                            â”‚                          â”‚
```

## Page Refresh (Auto-unlock) Flow
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”
â”‚ User    â”‚                 â”‚ Frontend â”‚                 â”‚ Backend â”‚                 â”‚ Redis â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”¬â”€â”€â”€â”˜
     â”‚                           â”‚                            â”‚                          â”‚
     â”‚ 1. Refresh Page           â”‚                            â”‚                          â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚                          â”‚
     â”‚                           â”‚                            â”‚                          â”‚
     â”‚                           â”‚ 2. Check localStorage      â”‚                          â”‚
     â”‚                           â”‚    for session token       â”‚                          â”‚
     â”‚                           â”‚                            â”‚                          â”‚
     â”‚                           â”‚ 3. Found valid token?      â”‚                          â”‚
     â”‚                           â”‚    (not expired)           â”‚                          â”‚
     â”‚                           â”‚                            â”‚                          â”‚
     â”‚                           â”‚ 4. POST /session/unlock    â”‚                          â”‚
     â”‚                           â”‚    Bearer: sessionToken    â”‚                          â”‚
     â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
     â”‚                           â”‚                            â”‚                          â”‚
     â”‚                           â”‚                            â”‚ 5. Validate Session      â”‚
     â”‚                           â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                           â”‚                            â”‚                          â”‚
     â”‚                           â”‚                            â”‚ 6. Return Session Data   â”‚
     â”‚                           â”‚                            â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                           â”‚                            â”‚                          â”‚
     â”‚                           â”‚ 7. Return wallet data      â”‚                          â”‚
     â”‚                           â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚
     â”‚                           â”‚                            â”‚                          â”‚
     â”‚                           â”‚ 8. Auto-unlock wallet      â”‚                          â”‚
     â”‚                           â”‚    (no passkey needed!)    â”‚                          â”‚
     â”‚                           â”‚                            â”‚                          â”‚
     â”‚ 9. Show Dashboard         â”‚                            â”‚                          â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚                          â”‚
     â”‚                           â”‚                            â”‚                          â”‚
```

## Session Expiry Flow
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”
â”‚ User    â”‚                 â”‚ Frontend â”‚                 â”‚ Backend â”‚                 â”‚ Redis â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”¬â”€â”€â”€â”˜
     â”‚                           â”‚                            â”‚                          â”‚
     â”‚                           â”‚ 1. Session Manager         â”‚                          â”‚
     â”‚                           â”‚    (runs every 60s)        â”‚                          â”‚
     â”‚                           â”‚                            â”‚                          â”‚
     â”‚                           â”‚ 2. Check token expiry      â”‚                          â”‚
     â”‚                           â”‚    (30min passed?)         â”‚                          â”‚
     â”‚                           â”‚                            â”‚                          â”‚
     â”‚                           â”‚ 3. Token expired!          â”‚                          â”‚
     â”‚                           â”‚                            â”‚                          â”‚
     â”‚                           â”‚ 4. Clear localStorage      â”‚                          â”‚
     â”‚                           â”‚                            â”‚                          â”‚
     â”‚                           â”‚ 5. Lock wallet             â”‚                          â”‚
     â”‚                           â”‚                            â”‚                          â”‚
     â”‚ 6. Redirect to Unlock     â”‚                            â”‚                          â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚                          â”‚
     â”‚                           â”‚                            â”‚                          â”‚
     â”‚                           â”‚                            â”‚ (Redis auto-expires      â”‚
     â”‚                           â”‚                            â”‚  after 30min TTL)        â”‚
     â”‚                           â”‚                            â”‚                          â”‚
```

## Manual Lock Flow
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User    â”‚                 â”‚ Frontend â”‚                 â”‚ Backend â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                           â”‚                            â”‚
     â”‚ 1. Click "Lock Wallet"    â”‚                            â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
     â”‚                           â”‚                            â”‚
     â”‚                           â”‚ 2. Clear session token     â”‚
     â”‚                           â”‚    from localStorage       â”‚
     â”‚                           â”‚                            â”‚
     â”‚                           â”‚ 3. Clear wallet state      â”‚
     â”‚                           â”‚    (privateKey, etc.)      â”‚
     â”‚                           â”‚                            â”‚
     â”‚ 4. Redirect to Welcome    â”‚                            â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
     â”‚                           â”‚                            â”‚
```

## Key Points

### ðŸ”’ Security Features
- **30-minute session validity** - Hard limit enforced client and server side
- **Auto-lock on expiry** - Client automatically locks when session expires
- **Manual lock** - Immediately clears session token
- **Token in localStorage** - Persists across tabs but cleared on lock
- **HTTPS required** - All API calls must use secure transport

### âš¡ Performance Benefits
- **No passkey on refresh** - Users stay logged in for 30 minutes
- **Fast unlock** - Session unlock is instant (no biometric prompt)
- **Multi-tab support** - Session works across browser tabs
- **Reduced backend load** - Fewer passkey verifications

### ðŸŽ¯ User Experience
- **Seamless experience** - Login once, use for 30 minutes
- **No re-authentication** - Page refresh doesn't log you out
- **Predictable expiry** - Clear 30-minute window
- **Quick re-login** - Passkey makes re-authentication fast when needed
